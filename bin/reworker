#!/usr/bin/env node

var program = require('commander'),
    rework = require('rework'),
    whitespace = require('css-whitespace'),
    minify = require('clean-css').process,
    path = require('path'),
    join = path.join,
    stdin = require('stdin');


// Usage

program
  .version(require('../package').version)
  .option('--variant <name>', 'build a variant')
  .option('-c', '--config <file>', 'path to the rework config')
  .option('--minify', 'compress the CSS output')
  .option('-s', '--whitespace', 'parse CSS through css-whitespace');


// Parse the CLI arguemtns

program.parse(process.argv);


// Load the config file

try {
  var file = join(process.cwd(), program.config || './rework.js');
  var config = require(file);
}
catch(e) {
  console.error('No rework.js file found');
  process.exit(1);
}


// Process stdin, run the config, output to stdout

stdin(function(css){

  if(program.whitespace) {
    css = whitespace(css);
  }

  var style = rework(css);
  style.variant = program.variant;
  style = config(style, rework);

  var compiled = style.toString();

  if(program.minify) {
    compiled = minify(compiled);
  }

  process.stdout.write(compiled);
});